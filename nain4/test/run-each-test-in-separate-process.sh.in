#!/usr/bin/env sh

if $1 -eq "-v"; then
    verbose=true
    shift
else
    verbose=false
fi


PATTERN=$1
if [ ! -z $2 ]; then
    shift
    shift
fi
FLAGS=$@

NPASSED=0
NFAILED=0
FAILED=

EXE=@CMAKE_INSTALL_PREFIX@/bin/@TEST_EXECUTABLE@

while read -r testname
do
    OUTPUT=$($EXE "$testname" ${FLAGS})
    STATUS=$?
    if [ $STATUS -ne 0 ]; then
        if $verbose; then printf "\\033[91m    %s\n" "${testname}";
        else              printf "\\033[91mF";
        fi
        FAILED=$FAILED"$testname"\\n
        NFAILED=$((NFAILED+1))
    else
        if $verbose; then printf "\\033[32m    %s\n" "${testname}";
        else              printf "\\033[32m.";
        fi
        NPASSED=$((NPASSED+1))
    fi
done < <($EXE ${PATTERN} --list-tests --verbosity quiet)
echo
echo
if ! [ -z "$FAILED" ]; then
    printf "\\033[91m===========================================================================\n"
    printf "\\033[32m Passed $NPASSED tests, \\033[91m Failed $NFAILED\n\n"
    printf "\\033[91m Failures: \n\n$FAILED\n"
    printf "\\033[91m===========================================================================\n"
    printf "\\033[91mOVERALL: ============================== FAIL ==============================\n"
    printf "\\033[91m===========================================================================\n"
    printf "\\033[0m"
    exit 1
else
    printf "\\033[32m Ran $NPASSED tests\n\n"
    printf "\\033[32m===========================================================================\n"
    printf "\\033[32mOVERALL: ============================== PASS ==============================\n"
    printf "\\033[32m===========================================================================\n"
    printf "\\033[0m"
fi
